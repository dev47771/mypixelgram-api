pipeline {
    agent any
    environment {
        ENV_TYPE = "production"
        PORT = 4128
        NAMESPACE = "mypixelgram-ru"
        REGISTRY_HOSTNAME = "daarrys"
        PROJECT = "mypixelgram-payment-api"
        SERVICE = "payment"
        REGISTRY = "registry.hub.docker.com"
        DEPLOYMENT_NAME = "mypixelgram-payment-api-deployment"
        IMAGE_NAME = "${env.BUILD_ID}_${env.ENV_TYPE}_${env.GIT_COMMIT}"
        DOCKER_BUILD_NAME = "${env.REGISTRY_HOSTNAME}/${env.PROJECT}:${env.IMAGE_NAME}"
    }

    stages {
        stage('Clone repository') {
            steps { checkout scm }
        }
        stage('Install dependencies') {
            steps {
                script {
                    sh '''
                        export NVM_DIR="$HOME/.nvm"
                        [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
                        nvm install 20
                        nvm use 20
                        yarn install --frozen-lockfile
                    '''
                }
            }
        }
        stage('Apply database migrations') {
            steps {
                echo "Migration started"
                script {
                    sh '''
                        export NVM_DIR="$HOME/.nvm"
                        [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
                        nvm use 20
                        export DATABASE_URL="mysql://mysqluser%40node-project-mysql-server:5uper%24tr0ngp%40ssw0rd@node-project-mysql-server.mysql.database.azure.com:3306/node_project?ssl=true"
                        yarn payment:migrate
                    '''
                }
                echo "Migration finished"
            }
        }
        stage('Unit tests') {
            steps {
                script {
                    sh '''
                        export NVM_DIR="$HOME/.nvm"
                        [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
                        nvm install 20
                        nvm use 20
                        yarn install
                        yarn test
                    '''
                }
            }
        }
        stage('e2e tests') {
            steps {
                script {
                    sh '''
                        export NVM_DIR="$HOME/.nvm"
                        [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
                        nvm install 20
                        nvm use 20
                        yarn test:e2e
                    '''
                }
            }
        }
        stage('Build docker image') {
            steps {
                echo "Build image started..."
                script {
                    app = docker.build("${env.DOCKER_BUILD_NAME}", "--build-arg service=${env.SERVICE} --build-arg port=${env.PORT} -f ./apps/${env.SERVICE}/Dockerfile ./")
                }
                echo "Build image finished..."
            }
        }
        stage('Push docker image') {
            steps {
                echo "Push image started..."
                script {
                    docker.withRegistry("https://${env.REGISTRY}", 'mypixelgram-ru') {
                        app.push("${env.IMAGE_NAME}")
                    }
                }
                echo "Push image finished..."
            }
        }
        stage('Delete image local') {
            steps {
                script {
                    sh "docker rmi -f ${env.DOCKER_BUILD_NAME}"
                }
            }
        }
        stage('Preparing deployment') {
            steps {
                echo "Preparing started..."
                sh 'ls -ltr'
                sh 'pwd'
                sh "chmod +x ./apps/${env.SERVICE}/preparingDeploy.sh"
                sh "./apps/${env.SERVICE}/preparingDeploy.sh ${env.REGISTRY_HOSTNAME} ${env.PROJECT} ${env.IMAGE_NAME} ${env.DEPLOYMENT_NAME} ${env.PORT} ${env.NAMESPACE}"
                sh "cat ./apps/${env.SERVICE}/deployment.yaml"
            }
        }
        stage('Deploy to Kubernetes') {
            steps {
                withKubeConfig([credentialsId: 'prod-kubernetes']) {
                    sh "kubectl apply -f ./apps/${env.SERVICE}/deployment.yaml"
                    sh "kubectl rollout status deployment/${env.DEPLOYMENT_NAME} --namespace=${env.NAMESPACE}"
                    sh "kubectl get services -o wide"
                }
            }
        }
    }
}
